#!/bin/bash

#new boards have to udpate this
BOARD=altera_3c25_board						#this has to have the name of the directory this file is in
DEVICE_PART=EP3C25Q240C8
FAMILY_PART="Cyclone III"
CONSTRAINT_FILE='altera_3c25_board.ucf'
PROJECT_FILE=minsoc_top.qsf
#SW_VERSION=`quartus_map -v | grep Version`
#~new boards update

#system workings
MINSOC_DIR=`pwd`/../..
BACKEND_DIR=$MINSOC_DIR/backend
SYN_DIR=$MINSOC_DIR/syn
SYNSRC_DIR=$MINSOC_DIR/prj/altera
SYNSUPPORT_DIR=$SYN_DIR/buildSupport
MAKEFILE_DIR=$SYN_DIR/altera

SYN_FILES=(adbg_top.prj jtag_top.prj or1200_top.prj uart_top.prj minsoc_top.prj altera_virtual_jtag.prj)
MAKEFILE=Makefile

FIND_PART='DEVICE_PART'
FIND_FAMILY='FAMILY_PART'
FIND_VERSION='SW_VERSION'
FIND_CONSTRAINT='CONSTRAINT_FILE'

BOARD_DIR=$BACKEND_DIR/$BOARD
BOARD_FILES=(board.h orp.ld minsoc_defines.v minsoc_bench_defines.v gcc-opt.mk $CONSTRAINT_FILE)

in_minsoc=`pwd | grep minsoc/backend/${BOARD}$`
if [ -z $in_minsoc ]
then
	echo ""
	echo "			!!!WARNING!!!"
	echo "This script cannot be run if not in a board directory inside minsoc/backend,"
	echo "because it relies on the directory structure of the minsoc system."
	echo ""
	echo "Possibly your minsoc directory is named differently, minsoc_trunk for example."
	echo "Its name must be minsoc only."
	echo ""
	exit 1
fi

echo ""
echo "This script sets up the SoC for simulations and synthesis."
echo ""
echo "In order to do so, SoC board's specific files for firmware compilation, "
echo "testbench generation and synthesis are configured."
echo "Firmware and testbench looks for board specific files under $BACKEND_DIR."
echo "Synthesis work under $SYN_DIR."
echo ""
echo ""

echo "Generating project files for simulation and synthesis..."
make -C $MINSOC_DIR/prj
echo "Generation complete."
echo "__________________________________________________________________________"
echo ""

if [ $CONSTRAINT_FILE == 'NONE' ]
then
    echo "Skipping synthesis preparation. Standard implementation can only be simulated."
else
    echo "Device part and family for files under $SYNSRC_DIR will patched and stored "
    echo "temporarily." 
    echo "Afterwards, they are copied to $SYNSUPPORT_DIR."
    echo "__________________________________________________________________________"
    echo ""
    sed "s/$FIND_PART/$DEVICE_PART/g" $MAKEFILE_DIR/$PROJECT_FILE > TMPFILE
    sed "s/$FIND_FAMILY/$FAMILY_PART/g" TMPFILE > TMPFILE2
    #sed "s/$FIND_VERSION/$SW_VERSION/g" TMPFILE> TMPFILE
    echo "Adding settings from constraint file..."
    cat $CONSTRAINT_FILE >> TMPFILE2

    echo "Generating quartus settings from prj files in $SYNSRC_DIR"
    for file in "${SYN_FILES[@]}"
    do
        echo "Adding settings from file $file..."
    	cat $SYNSRC_DIR/$file >> TMPFILE2 
    done
    mv TMPFILE2 $SYNSUPPORT_DIR/$PROJECT_FILE
    rm TMPFILE
    echo ""
    echo "Generated quartus settings file in $SYNSUPPORT_DIR/$PROJECT_FILE"
    echo ""

    echo "Copying Makefile from $MAKEFILE_DIR to synthesis directory, $SYN_DIR..."
    cp $MAKEFILE_DIR/$MAKEFILE $SYN_DIR/$MAKEFILE
    echo ""

    echo "Copying board specific SoC files from $BOARD_DIR to $BACKEND_DIR directory."
    echo "__________________________________________________________________________"
    echo ""
    for file in "${BOARD_FILES[@]}"
    do
	if [ $file != NONE ]
	then
            echo "Copying $file, to backend directory..."
            cp $BOARD_DIR/$file $BACKEND_DIR
	fi
    done
    echo ""
    echo "Configuration done."
    echo "For synthesis help go to $SYN_DIR and type \"make\"."
fi

